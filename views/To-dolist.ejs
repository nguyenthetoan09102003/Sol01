<%- include('./partials/header.ejs') %>
<div class="container-fluid ">
    <div class="row mb-3 mt-3">
        <div class="col-md-8">
            <h2 class="text-primary"><i class="fa-solid fa-clipboard-list"></i> To-do List</h2>
        </div>
        <div class="col-md-4 text-end">
            <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#generateTodoModal">
                <i class="fa-solid fa-sync"></i> Tạo từ Checklist
            </button>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addTodoModal">
                <i class="fa-solid fa-plus"></i> Thêm công việc
            </button>
        </div>
    </div>
    
    <!-- Filter Section -->
    <div class="row mb-3">
        <div class="col-md-12">
            <div class="card">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-4">
                            <label class="form-label">Trạng thái:</label>
                            <select id="statusFilter" class="form-select" onchange="filterTodos()">
                                <option value="all">Tất cả</option>
                                <option value="pending">Chờ xử lý</option>
                                <option value="in_progress">Đang xử lý</option>
                                <option value="completed">Hoàn thành</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Máy:</label>
                            <select id="machineFilter" class="form-select" onchange="filterTodos()">
                                <option value="all">Tất cả máy</option>
                                <option value="PD1">PD1</option>
                                <option value="PB1">PB1</option>
                                <option value="PC4">PC4</option>
                                <option value="PC3">PC3</option>
                                <option value="PM1">PM1</option>
                                <option value="PM2">PM2</option>
                                <option value="PM3">PM3</option>
                                <option value="PM4">PM4</option>
                                <option value="PM5">PM5</option>
                                <option value="PM6">PM6</option>
                                <option value="PR1">PR1</option>
                                <option value="PR2">PR2</option>
                                <option value="PR3">PR3</option>
                                <option value="PR4">PR4</option>
                                <option value="PR5">PR5</option>
                                <option value="PR6">PR6</option>
                                <option value="PP1">PP1</option>
                                <option value="PE1">PE1</option>
                                <option value="PE2">PE2</option>
                                <option value="PE3">PE3</option>                            </select>
                        </div>
                        
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Todos Table -->
    <div class="row">
        <div class="col-md-12">
            <div class="table-responsive">
                <table class="table table-hover table-bordered text-center align-middle" id="todosTable" >
                    <thead class="table-dark">
                        <tr>
                            <th style="width: 5%">#</th>
                            <th style="width: 12%">Máy</th>
                            <th style="width: 15%">Vị trí</th>
                            <th style="width: 15%">Điểm kiểm tra</th>
                            <th style="width: 25%">Vấn đề</th>
                            <th style="width: 10%">Người kiểm tra</th>
                            <th style="width: 10%">Trạng thái</th>
                            <th style="width: 8%">Thao tác</th>
                        </tr>
                    </thead>
                    <tbody >
                        <% if (typeof todos !== 'undefined' && todos.length > 0) { %>
                            <% todos.forEach((todo, index) => { %>
                                <tr data-status="<%= todo.status %>" data-machine="<%= todo.machineName %>" data-date="<%= new Date(todo.createdAt).toISOString().split('T')[0] %>">
                                    <td><%= index + 1 %></td>
                                    <td><span><%= todo.machineName %></span></td>
                                    <td><%= todo.position || '-' %></td>
                                    <td><%= todo.checkpoint || '-' %></td>
                                    <td><%= todo.comment || '-' %></td>
                                    <td>
                                        <% if (todo.checkedBy) { %>
                                            <small><%= todo.checkedBy %></small><br>
                                            <% if (todo.dateChecked) { %>
                                                <small class="text-muted"><%= new Date(todo.dateChecked).toLocaleDateString('vi-VN') %></small>
                                            <% } %>
                                        <% } else { %>
                                            -
                                        <% } %>
                                    </td>
                                    <td>
                                        <select class="form-select form-select-sm status-select" data-todo-id="<%= todo._id %>" onchange="updateStatus('<%= todo._id %>', this.value)">
                                            <option value="pending" <%= todo.status === 'pending' ? 'selected' : '' %>>
                                                Chờ xử lý
                                            </option>
                                            <option value="in_progress" <%= todo.status === 'in_progress' ? 'selected' : '' %>>
                                                Đang xử lý
                                            </option>
                                            <option value="completed" <%= todo.status === 'completed' ? 'selected' : '' %>>
                                                Hoàn thành
                                            </option>
                                        </select>
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-danger" onclick="deleteTodo('<%= todo._id %>')">
                                            <i class="fa-solid fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                            <% }); %>
                        <% } else { %>
                            <tr>
                                <td colspan="8" class="text-center text-muted py-4">
                                    <i class="fa-solid fa-inbox fa-2x"></i>
                                    <p class="mt-2">Chưa có công việc nào</p>
                                </td>
                            </tr>
                        <% } %>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Generate Todo Modal -->
<div class="modal fade" id="generateTodoModal" tabindex="-1" aria-labelledby="generateTodoModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="generateTodoModalLabel">Tạo công việc từ Checklist</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="generateTodoForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Chọn cách lọc:</label>
                        <select class="form-select" id="filterType" onchange="toggleFilterOptions()">
                            <option value="days">Số ngày gần nhất</option>
                            <option value="daterange">Chọn khoảng thời gian</option>
                        </select>
                    </div>
                    
                    <!-- Days Filter -->
                    <div id="daysFilterSection">
                        <div class="mb-3">
                            <label class="form-label">Số ngày gần nhất:</label>
                            <select class="form-select" name="days">
                                <option value="3">3 ngày</option>
                                <option value="7" selected>7 ngày</option>
                                <option value="14">14 ngày</option>
                                <option value="30">30 ngày</option>
                                <option value="60">60 ngày</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Date Range Filter -->
                    <div id="dateRangeFilterSection" style="display: none;">
                        <div class="mb-3">
                            <label class="form-label">Từ ngày:</label>
                            <input type="date" class="form-control" name="startDate">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Đến ngày:</label>
                            <input type="date" class="form-control" name="endDate">
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Chọn máy (tùy chọn):</label>
                        <select class="form-select" name="machineName">
                            <option value="all">Tất cả máy</option>
                            <option value="PD1">PD1</option>
                            <option value="PB1">PB1</option>
                            <option value="PC4">PC4</option>
                            <option value="PC3">PC3</option>
                            <option value="PM1">PM1</option>
                            <option value="PM2">PM2</option>
                            <option value="PM3">PM3</option>
                            <option value="PM4">PM4</option>
                            <option value="PM5">PM5</option>
                            <option value="PM6">PM6</option>
                            <option value="PR1">PR1</option>
                            <option value="PR2">PR2</option>
                            <option value="PR3">PR3</option>
                            <option value="PR4">PR4</option>
                            <option value="PR5">PR5</option>
                            <option value="PR6">PR6</option>
                            <option value="PP1">PP1</option>
                            <option value="PE1">PE1</option>
                        </select>
                    </div>
                    
                    <div class="alert alert-info">
                        <i class="fa-solid fa-info-circle"></i> Chỉ các checklist có comment sẽ được chuyển thành công việc cần xử lý.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                    <button type="submit" class="btn btn-success">Tạo công việc</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Add Todo Modal -->
<div class="modal fade" id="addTodoModal" tabindex="-1" aria-labelledby="addTodoModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addTodoModalLabel">Thêm công việc mới</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="addTodoForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Máy *</label>
                        <select class="form-select" name="machineName" required>
                            <option value="PD1" selected>PD1</option>
                            <option value="PB1">PB1</option>
                            <option value="PC4">PC4</option>
                            <option value="PC3">PC3</option>
                            <option value="PM1">PM1</option>
                            <option value="PM2">PM2</option>
                            <option value="PM3">PM3</option>
                            <option value="PM4">PM4</option>
                            <option value="PM5">PM5</option>
                            <option value="PM6">PM6</option>
                            <option value="PR1">PR1</option>
                            <option value="PR2">PR2</option>
                            <option value="PR3">PR3</option>
                            <option value="PR4">PR4</option>
                            <option value="PR5">PR5</option>
                            <option value="PR6">PR6</option>
                            <option value="PP1">PP1</option>
                            <option value="PE1">PE1</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Vị trí</label>
                        <input type="text" class="form-control" name="position" placeholder="Ví dụ: Lubricant system">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Điểm kiểm tra</label>
                        <input type="text" class="form-control" name="checkpoint" placeholder="Ví dụ: Oil level / Mức dầu">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Vấn đề / Ghi chú *</label>
                        <textarea class="form-control" name="comment" rows="3" required placeholder="Mô tả vấn đề cần xử lý..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                    <button type="submit" class="btn btn-primary">Tạo công việc</button>
                </div>
            </form>
        </div>
    </div>
</div>
<script src="/js/todo.js"></script>
<%- include('./partials/footer.ejs') %>
